<mujoco model="1dof_joint_full_physics_fixed">
    <!-- 
       编译器与仿真设置 
    -->
    <compiler angle="radian" autolimits="true" inertiafromgeom="true"/>
    <option timestep="0.002" integrator="RK4" gravity="0 0 -9.81">
      <flag contact="enable" energy="enable"/>
    </option>
  
    <statistic center="0.2 0 0.5" extent="0.8"/>
  
    <visual>
      <headlight diffuse="0.6 0.6 0.6" ambient="0.3 0.3 0.3" specular="0 0 0"/>
      <rgba haze="0.15 0.25 0.35 1"/>
      <global azimuth="140" elevation="-20"/>
    </visual>
  
    <default>
      <!-- 通用关节参数：降低摩擦以突显齿槽效应 -->
      <joint damping="0.02" frictionloss="0.02" armature="0.005"/>
      <geom type="cylinder" size="0.05 0.02" rgba="0.7 0.7 0.7 1"/>
      
      <!-- 
         [齿槽效应专用接触配置]
         solref: "0.02 1" -> 模拟磁力的柔性，允许小球互相"穿过"产生力
         margin: 0.005 -> 增大感应范围，让过度更平滑
      -->
      <default class="cogging_contact">
        <geom type="sphere" size="0.008" rgba="0.9 0.2 0.2 0.5" solref="0.02 1" solimp="0.9 0.95 0.001" margin="0.005"/>
      </default>
    </default>
  
    <asset>
      <texture type="2d" name="groundplane" builtin="checker" mark="edge" rgb1="0.2 0.3 0.4" rgb2="0.1 0.2 0.3" markrgb="0.8 0.8 0.8" width="300" height="300"/>
      <material name="ground_mat" texture="groundplane" texuniform="true" texrepeat="5 5" reflectance="0.2"/>
      <texture type="skybox" builtin="gradient" rgb1="0.3 0.5 0.7" rgb2="0 0 0" width="512" height="300"/>
    </asset>
  
    <worldbody>
      <light pos="0 0 2" dir="0 0 -1" directional="true"/>
      <geom name="floor" type="plane" size="0 0 0.1" material="ground_mat"/>
  
      <!-- [修复1] 基座抬高到 0.5 -->
      <body name="base_link" pos="0 0 0.5">
        <geom type="box" size="0.06 0.06 0.06" rgba="0.2 0.2 0.2 1" mass="5.0"/>
        <!-- 电机外壳 -->
        <geom type="cylinder" size="0.05 0.08" quat="0.707 0 0.707 0" pos="0.08 0 0" rgba="0.3 0.3 0.3 1" mass="1.0"/>
  
        <!-- 
           >>> 齿槽效应生成器 (Stator Ring) <<<
           [修复2] 将定子环的位置移到 0.2，与转子轴心重合
           旋转 90 度 (quat="0.707 0 0.707 0") 使其垂直于 X 轴
        -->
        <body name="cogging_stator_ring" pos="0.2 0 0" quat="0.707 0 0.707 0">
           <!-- 定义8个定子极，半径 0.04 -->
           <geom class="cogging_contact" pos="0.04 0.00 0.00"/>
           <geom class="cogging_contact" pos="0.028 0.028 0.00"/>
           <geom class="cogging_contact" pos="0.00 0.04 0.00"/>
           <geom class="cogging_contact" pos="-0.028 0.028 0.00"/>
           <geom class="cogging_contact" pos="-0.04 0.00 0.00"/>
           <geom class="cogging_contact" pos="-0.028 -0.028 0.00"/>
           <geom class="cogging_contact" pos="0.00 -0.04 0.00"/>
           <geom class="cogging_contact" pos="0.028 -0.028 0.00"/>
        </body>
  
        <!-- 
           [修复3] 转子轴心移到 0.2，避开基座
        -->
        <body name="motor_rotor" pos="0.2 0 0" euler="0 1.5708 0">
          <!-- 理想关节 (转子) -->
          <joint name="joint_ideal" type="hinge" axis="0 0 1" range="-30 30" limited="false"/>
          
          <!-- 
             >>> 齿槽效应生成器 (Rotor Pole) <<<
             转子上的磁极。位置半径也是 0.04，与定子极发生干涉。
          -->
          <body name="cogging_rotor_pole" pos="0 0 0">
             <!-- 绿色小球：产生力的磁极 -->
             <geom class="cogging_contact" pos="0.04 0 0" rgba="0.2 0.9 0.2 1"/>
             <!-- 虚拟配重：不参与碰撞 (group=1)，仅为了视觉平衡 -->
             <geom type="sphere" size="0.008" pos="-0.04 0 0" rgba="0.2 0.9 0.2 0.3" group="1" mass="0"/>
          </body>
  
          <!-- 减速器输出轴可视化 -->
          <geom type="cylinder" size="0.015 0.02" rgba="0.9 0.5 0.1 1" mass="0.1"/>
  
          <!-- 实际负载与回差 -->
          <body name="actual_load" pos="0 0 0">
            <!-- 回差关节 -->
            <joint name="joint_backlash" type="hinge" axis="0 0 1" 
                   range="-0.005 0.005" limited="true" 
                   stiffness="0" damping="0.005" armature="0"/>
            
            <inertial pos="0.15 0 0" mass="0.8" diaginertia="0.002 0.002 0.002"/>
            
            <!-- 摆臂 -->
            <geom type="box" size="0.15 0.02 0.005" pos="0.15 0 0" rgba="0 0.5 0.8 1"/>
            <geom type="sphere" size="0.03" pos="0.3 0 0" rgba="1 0 0 1" mass="0.5"/>
            <site name="tip_site" pos="0.3 0 0" size="0.01" rgba="0 1 0 1"/>
          </body>
        </body>
      </body>
    </worldbody>
  
    <!-- 
       [修复4] 关键：排除基座与负载的碰撞
       只保留 cogging_contact 之间的碰撞
    -->
    <contact>
      <exclude body1="base_link" body2="actual_load"/>
      <exclude body1="base_link" body2="motor_rotor"/>
    </contact>
  
    <actuator>
      <!-- 减速比 6 -->
      <motor name="motor_driver" joint="joint_ideal" gear="6" ctrllimited="true" ctrlrange="-5 5"/>
    </actuator>
  
    <sensor>
      <jointpos name="encoder_pos" joint="joint_ideal"/>
      <jointvel name="encoder_vel" joint="joint_ideal"/>
      <framepos name="load_tip_pos" objtype="site" objname="tip_site"/>
      <actuatorfrc name="motor_torque" actuator="motor_driver"/>
    </sensor>
  </mujoco>